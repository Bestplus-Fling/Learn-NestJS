# 2025-12-11 개발일지

- 강의: [따라하며 배우는 NestJS](https://inf.run/jo7XN)

## 오늘 한 일

- TypeORM 설치

  - `@nestjs/typeorm` NestJS에서 TypeORM을 사용하기 위해 연동시켜주는 모듈
  - `typeorm`: TypeORM 모듈
  - `pg`: Postgres 모듈
  - 설치 명령어: `npm install pg typeorm @nestjs/typeorm --save`

- typeorm.config.ts 추가 => 환경변수 때문에 정상적으로 동작하지 않음

  - DB 커넥션을 위한 설정 저장
  - `app.module.ts`에 추가

    ```ts
    import { TypeOrmModule } from '@nestjs/typeorm';
    import { typeORMConfig } from 'src/configs/typeorm.config';

    @Module({
      imports: [
        TypeOrmModule.forRoot(typeORMConfig),
        BoardsModule
      ],
    })
    ```

  - 환경변수를 적용하기 위한 최종본

    ```ts
    import { TypeOrmModule } from '@nestjs/typeorm';
    import { ConfigModule, ConfigService } from '@nestjs/config';

    @Module({
      imports: [
        // ...
        TypeOrmModule.forRootAsync({
          imports: [ConfigModule],
          useFactory: (config: ConfigService) => ({
            type: 'postgres',
            host: config.get('DB_HOST'),
            port: Number(config.get('DB_PORT')),
            username: config.get('DB_USERNAME'),
            password: config.get('DB_PASSWORD'),
            database: 'board-app',
            autoLoadEntities: true,
            synchronize: true,
          }),
          inject: [ConfigService],
        }),
        // ...
      ],
    })
    ```

- Repository 생성

  - `board.repository.ts`에서 다음과 같이 사용

    - 기존 EntityRepository가 deprecated(유지보수가 중단되어, 사용이 권장되지 않는)되었기 때문에 다른 방법으로 구현

    ```ts
    import { DataSource, Repository } from "typeorm";

    @Injectable()
    export class BoardRepository extends Repository<Board> {
      // DataSource를 가져오고, super 메소드를 사용해 등독한다.
      constructor(private dataSource: DataSource) {
        super(Board, dataSource.createEntityManager());
      }
    }
    ```

  - 생성한 Repository를 다른 곳에서 사용할 수 있도록 `board.module`에 추가

    ```ts
    import { TypeOrmModule } from "@nestjs/typeorm";
    import { Board } from "src/boards/board.entity";
    import { BoardRepository } from "src/boards/board.repository";

    @Module({
      imports: [TypeOrmModule.forFeature([Board])],
      controllers: [BoardsController],
      providers: [BoardsService, BoardRepository],
    })
    export class BoardsModule {}
    ```

- 환경변수를 사용하기 위해 `@nestjs/config` 설치

  - `npm install @nestjs/config --save`
  - 이후 `app.module.ts`에 다음과 같이 적용

    ```ts
    //...
    import { ConfigModule } from '@nestjs/config';

    @Module({
    imports: [
      ConfigModule.forRoot({
        envFilePath: '.env',
        isGlobal: true,
      }),
      //...
    ],

    })
    ```

- 게시글 상태 변경시 Status에 대한 Validation용 pipe 생성

  ```ts
  import { BadRequestException, PipeTransform } from "@nestjs/common";
  import { BoardStatus } from "src/boards/board-status.enum";

  export class BoardStatusValidationPipe implements PipeTransform {
    // status는 두가지 뿐이므로, 두 가지 옵션에 대해서만 검증을 진행
    readonly StatusOptions: BoardStatus[] = [
      BoardStatus.PRIVATE,
      BoardStatus.PUBLIC,
    ];

    transform(value: unknown): BoardStatus {
      // 입력된 value가 string 타입인지 1차적으로 검증
      if (typeof value !== "string") {
        throw new BadRequestException("Status must be a string");
      }
      // value를 대문자로 변경
      const upperValue = value.toUpperCase() as BoardStatus;
      // 대문자로 변경한 status가 일치하는지 확인
      if (!this.isStatusValid(upperValue)) {
        // 만약 일치하지 않는다면 Exception 실행
        throw new BadRequestException(
          `${upperValue} isn't in the status options`
        );
      }
      // 정상적인 입력값이라면 그대로 값을 반환
      return upperValue;
    }
    // 두 가지 옵션에 일치하는지 확인
    private isStatusValid(status: BoardStatus): boolean {
      // indexOf를 사용하면 일치하는 값의 인덱스 번호를 반환한다.
      const index = this.StatusOptions.indexOf(status);
      // 만약 일치하는 값이 없다면 -1을 반환하기 때문에 -1과 일치한다면 잘못된 상황임.
      return index !== -1;
    }
  }
  ```

## 정리
