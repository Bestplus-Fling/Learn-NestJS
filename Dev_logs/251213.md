# 2025-12-13 개발일지

- 강의: [따라하며 배우는 NestJS](https://inf.run/jo7XN)

## 오늘 한 일

- **User Repository 생성**

  - `auth.service.ts`에서 User Entity를 직접 사용하는 대신, Repository 패턴을 적용하기 위해 `user.repository.ts`를 생성하고 관련 로직을 이전했습니다.
  - `auth.module.ts`에 `TypeOrmExModule`을 사용하여 커스텀 Repository를 등록했습니다.

- **로그인 기능 구현**

  - `auth.service.ts`에 `signIn` 메서드를 추가했습니다.
  - 사용자가 제공한 `username`으로 사용자를 조회합니다.
  - `bcrypt.compare`를 사용하여 비밀번호가 일치하는지 확인합니다.
  - 로그인 실패 시 `UnauthorizedException`을 발생시킵니다.

  ```ts
  // src/auth/auth.service.ts
  async signIn(authCredentialsDto: AuthCredentialsDto): Promise<{accessToken: string}> {
    const { username, password } = authCredentialsDto;
    const user = await this.userRepository.findOneBy({ username });

    if (user && (await bcrypt.compare(password, user.password))) {
      // 유저 토큰 생성 (Secret + Payload)
      const payload = { username }; // 중요한 정보는 넣지 않도록 주의
      const accessToken = await this.jwtService.sign(payload);

      return { accessToken };
    } else {
      throw new UnauthorizedException('login failed');
    }
  }
  ```

- **JWT를 이용한 인증 전략 수립**

  - `auth.module.ts`에 `JwtModule`과 `PassportModule`을 설정했습니다.
  - `jwt.strategy.ts` 파일을 생성하여 JWT 인증 전략을 구현했습니다.

    - 요청의 `Authorization` 헤더에서 JWT를 추출하고 유효성을 검사합니다.
    - 유효한 토큰인 경우, payload에 포함된 `username`으로 사용자를 찾아 `request.user`에 주입합니다.

  - `auth.module.ts`

    ```ts
    import { Module } from "@nestjs/common";
    import { AuthService } from "./auth.service";
    import { AuthController } from "./auth.controller";
    import { TypeOrmExModule } from "src/database/typeorm-ex.module";
    import { UserRepository } from "./user.repository";
    import { PassportModule } from "@nestjs/passport";
    import { JwtModule } from "@nestjs/jwt";
    import { JwtStrategy } from "./jwt.strategy";
    import { ConfigService } from "@nestjs/config";

    @Module({
      imports: [
        PassportModule.register({ defaultStrategy: "jwt" }),
        JwtModule.registerAsync({
          inject: [ConfigService],
          useFactory: (config: ConfigService) => ({
            secret: config.get("JWT_SECRET"),
            signOptions: {
              expiresIn: 3600, // 1시간
            },
          }),
        }),
        TypeOrmExModule.forCustomRepository([UserRepository]),
      ],
      controllers: [AuthController],
      // JwtStrategy를 이 모듈에서 사용할 수 있도록 등록
      providers: [AuthService, JwtStrategy],
      // JwtStrategy, PassportModule을 다른 모듈에서 사용할 수 있도록 export
      exports: [JwtStrategy, PassportModule],
    })
    export class AuthModule {}
    ```

## 정리

- JWT와 Passport를 사용하여 인증 시스템의 핵심 로직을 구현했습니다. 사용자는 이제 회원가입 후 로그인을 통해 `accessToken`을 발급받을 수 있습니다.
- 다음 단계는 발급받은 토큰을 사용하여 특정 API에 대한 접근을 제어하는 `AuthGuard`를 적용하는 것입니다.
